<!DOCTYPE html>
<meta charset="utf-8">
<title>SANKEY Experiment</title>
<style>

    .node rect {
        cursor: move;
        fill-opacity: .9;
        shape-rendering: crispEdges;
    }

    .node text {
        pointer-events: none;
        text-shadow: 0 1px 0 #fff;
    }

    .link {
        fill: none;
        stroke: #000;
        stroke-opacity: .2;
    }

    .link:hover {
        stroke-opacity: .5;
    }

</style>
<body>

<p id="chart">

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <script>

        const units = "Widgets";

        const margin = {top: 10, right: 10, bottom: 10, left: 10},
            width = 1200 - margin.left - margin.right,
            height = 740 - margin.top - margin.bottom;

        const formatNumber = d3.format(",.0f"),    // zero decimal places
            format = function (d) {
                return formatNumber(d) + " " + units;
            },
            color = d3.scaleOrdinal(d3.schemeCategory10);

        // append the svg canvas to the page
        const svg = d3.select("#chart").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

        // Set the sankey diagram properties
        const sankeyGen = d3.sankey()
            .nodeWidth(36)   // Width of the node in pixels
            .nodePadding(10) // Space between nodes
            .size([width, height])
            .nodeId(d => d.name); // Accessor function (retrive ID)

        // load the data
        d3.json("data/sankey.json").then(function(data) {

            const graph = sankeyGen(data);

            // add in the links
            const link = svg.append("g").selectAll(".link")
                .data(graph.links)
                .enter().append("path")
                .attr("class", "link")
                .attr("d", d3.sankeyLinkHorizontal())
                .style("stroke-width", function (d) {
                    return d.width;
                });

            // add the link titles
            link.append("title")
                .text(function(d) {
                    return d.source.name + " â†’ " +
                        d.target.name + "\n" + format(d.value); });

            // add in the nodes
            const node = svg.append("g").selectAll(".node")
                .data(graph.nodes)
                .enter().append("g")
                .attr("class", "node")
                .attr("transform", function (d) {
                    return "translate(" + d.x + "," + d.y + ")";
                })
                .call(d3.drag()
                    .subject(function (d) {
                        return d;
                    })
                    .on("start", function () {
                        this.parentNode.appendChild(this);
                    })
                    .on("drag", dragmove));

            // add the rectangles for the nodes
            node.append("rect")
                .attr("x", function(d) { return d.x0; })
                .attr("y", function(d) { return d.y0; })
                .attr("height", function(d) { return d.y1 - d.y0; })
                .attr("width", sankeyGen.nodeWidth())
                .style("fill", function(d) {
                    return d.color = color(d.name.replace(/ .*/, "")); })
                .style("stroke", function(d) {
                    return d3.rgb(d.color).darker(2); })
                .append("title")
                    .text(function(d) {
                        return d.name + "\n" + format(d.value); });

            // add in the title for the nodes
            node.append("text")
                .attr("x", function(d) { return d.x0 - 6; })
                .attr("y", function(d) { return (d.y1 + d.y0) / 2; })
                .attr("dy", "0.35em")
                .attr("text-anchor", "end")
                .text(function(d) { return d.name; })
                .filter(function(d) { return d.x0 < width / 2; })
                .attr("x", function(d) { return d.x1 + 6; })
                .attr("text-anchor", "start");

            // the function for moving the nodes
            function dragmove(event, d) {
                d3.select(this).attr("transform",
                    "translate(" + (
                        d.x = Math.max(0, Math.min(width - d.dx, event.x))
                    ) + "," + (
                        d.y = Math.max(0, Math.min(height - d.dy, event.y))
                    ) + ")");
                link.attr("d", path);
            }
        });

    </script>

</body>
</html>
